
{% extends "match_history/base.html" %}
{% load static  %}
{% block extra_styles %}
    <link rel="stylesheet" href="{% static 'match_history/css/details.css' %}">
{% endblock %}


{% block content %}
<div class="summoner-header">
    <div class="summoner-card">
        <div class="profile-icon-container">
            <img class="main-icon" src="{{summoner.profile_icon.get_url}}" alt="" >
            <div class="level">
                {{summoner.summoner_level}}
            </div>
        </div>
        <div class="summoner-name">
            <p class="large-text">{{summoner.game_name}} <span id="tag">#{{summoner.tag_line}}</span></p>
            <button id = "update">Update</button>
        </div>
    </div>
</div>
{#----------------------#}
<div class="loading-wrapper" style="">
    <div class='progress-wrapper'>
        <div id='progress-bar' class='progress-bar' style="background-color: #68a9ef; border-radius: 12px; width: 0%;">&nbsp; </div>
    </div>
    <div id="progress-bar-message"></div>
</div>
{#----------------------#}

<div class="main-info">
    <div class="sidebar">
        <div class="account-container section">
            <div class="section-header">
                <div class="title">Account Summary</div>
                <div class="year">2024</div>
            </div>
            <hr>
            <div class="account-card">
                {% include 'match_history/account_summary.html' %}
            </div>

        </div>
        <div class="snowball-container section">
            <div class="section-header">
                <div class="title">Snowballs</div>
                <div class="year">2024</div>
            </div>
            <hr>
            <div class="snowball-content">
                {% include 'match_history/snowballs.html' %}
            </div>

        </div>
        <div class="champion-container section">
            <div class="section-header">
                <div class="title">Champions Played</div>
                <div class="year">2024</div>
            </div>
            <hr>
            <div class="champ-list">
                {% include 'match_history/champ_list.html' %}
            </div>
        </div>

        <div class="recent-container section">
            <div class="section-header">
                <div class="title">Recently Played</div>
                <div class="year sub-text">(last {{recent_list.0}} games)</div>
            </div>
            <hr>
            <div class="recent-list">
                {% include 'match_history/recent_list.html' %}
            </div>
        </div>
    </div>

    <div class="match-history section">
        Match History
        <hr>
        <div id="match-list" data-total-pages ={{ total_pages }}>

            {% include "match_history/match_list.html"%}

        </div>
    </div>
</div>

{% endblock content %}
{% block extra_scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        let page = 2;  // Start from the second page since the first page is already loaded
        let loading = false;
        let noMorePages = false;  // Flag to indicate no more pages to load
        if ($('#match-list').children().length === 0) {
            console.log('No matches to load.');
            return;
        }

        $(window).scroll(function() {
            // Check if the user has scrolled near the bottom and a request is not in progress
            if (!loading && !noMorePages && $(window).scrollTop() + $(window).height() >= $(document).height() - 100) {
                loading = true;

                // Make an AJAX request to load the next page
                $.ajax({
                    url: window.location.href,
                    data: {
                        'page': page  // Pass the current page number to load
                    },
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(data, textStatus, xhr) {
                        if (xhr.status === 204 || data.trim() === '') {
                            noMorePages = true;
                            console.log("No more pages to load.");
                        } else {
                            // Append the loaded data to the match list
                            $('#match-list').append(data);

                            $('#match-list').append('<div class="done">Done with page ' + page + '</div>');

                            // Increment the page for the next load
                            page += 1;
                        }
                        loading = false;  // Reset loading flag
                    },
                    error: function() {
                        console.error("Error loading page " + page);
                        loading = false;  // Reset loading flag on error
                    }
                });
            }
        });
    });
</script>
    {% if summoner.being_parsed %}

        <script src="{% static 'celery_progress/celery_progress.js' %}"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                var progressUrl = "{% url 'celery_progress:task_status' task_id %}";

                function customProgress(progressBarElement, progressBarMessageElement, progress) {
                    progressBarElement.style.backgroundColor = this.barColors.progress;
                    progressBarElement.style.width = progress.percent + "%";
                    var description = progress.description || "";
                    if (progress.current === 0) {
                        if (progress.pending === true) {
                            progressBarMessageElement.textContent = this.messages.waiting;
                        } else {
                            progressBarMessageElement.textContent = this.messages.started;
                        }
                    } else {
                        progressBarMessageElement.textContent = progress.current + ' of ' + progress.total + ' matches processed. '
                    }

                }

                CeleryProgressBar.initProgressBar(progressUrl, {
                    pollInterval: 1000,
                    onSuccess: function() {
                        document.getElementById('progress-bar-message').innerText = "Success!";
                        window.location.reload();  // Reload the page once parsing is complete
                    },
                    onError: function() {
                        document.getElementById('progress-bar-message').innerText = "An error occurred.";
                    },
                    defaultMessages: {
                        waiting: 'Processing matches...',  // Custom message for the waiting state
                        started: 'Processing matches...'   // Custom message for the started state
                    },
                    onProgress: customProgress
                });
            });
        </script>
    {% endif %}
<script>
    $(document).ready(function() {
        function updateSections() {
            $.ajax({
                url: window.location.href,
                method: 'GET',
                data: {
                    'section': 'update'
                },
                success: function(response) {
                    console.log(response.recent_list);
                    $('.account-card').html(response.account_summary);
                    $('.champ-list').html(response.champion_list);
                    $('.recent-list').html(response.recent_list);
                    $('#match-list').prepend(response.match_list);

                    // Reset the button once the update sections have been processed
                    $('#update').text('Update');
                    setTimeout(function() {
                        $('#update').prop('disabled', false).text('Update');
                    }, 600000);
                },
                
                error: function() {
                    console.error("Error updating sections.");
                    $('#update').prop('disabled', false).text('Update (Failed)');
                }
            });
        }

        document.getElementById('update').addEventListener('click', function() {
            console.log("hey you clicked me");

            // Disable the button and show updating text
            $('#update').prop('disabled', true).text('Updating...');

            let summonerId = '{{ summoner.puuid }}';  // Ensure this renders correctly
            $.ajax({
                url: '{% url "match_history:update" %}',  // Confirm this URL with Django routing
                method: 'POST',
                data: {
                    'summoner_id': summonerId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    let taskId = response.task_id;
                    console.log(taskId);
                    pollTaskStatus(taskId);
                },
                error: function() {
                    console.error("Failed to start update task.");
                    $('#update').prop('disabled', false).text('Update (Failed)');
                }
            });
        });

        function pollTaskStatus(taskId) {
            let interval = setInterval(function() {
                let taskStatusUrl = `/celery-progress/${taskId}/`;
                $.ajax({
                    url: taskStatusUrl,
                    method: 'GET',
                    success: function(response) {
                        if (response.state === 'SUCCESS') {
                            console.log("success");
                            clearInterval(interval);
                            updateSections();
                        } else if (response.state === 'FAILURE') {
                            clearInterval(interval);
                            console.error("Task failed.");
                            $('#update').prop('disabled', false).text('Update (Failed)');
                        }
                    },
                    error: function() {
                        console.error("Failed to get task status.");
                        $('#update').prop('disabled', false).text('Update (Failed)');
                    }
                });
            }, 2000);
        }
    });
    
</script>



{% endblock %}